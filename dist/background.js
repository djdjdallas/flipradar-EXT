(()=>{var c="https://flipradar-iaxg.vercel.app";chrome.runtime.onMessage.addListener((r,o,e)=>{if(r.type==="openLogin")chrome.tabs.create({url:`${c}/auth/extension`}),e({success:!0});else if(r.type==="openUpgrade")chrome.tabs.create({url:`${c}/pricing`}),e({success:!0});else{if(r.type==="getAuthToken")return chrome.storage.local.get(["authToken","user"],t=>{e({token:t.authToken||null,user:t.user||null})}),!0;if(r.type==="logout")return chrome.storage.local.remove(["authToken","user"],()=>{e({success:!0})}),!0;if(r.type==="getApiBaseUrl")e({url:c});else if(r.type==="soldDataCaptured")chrome.tabs.query({url:"*://www.facebook.com/marketplace/*"},t=>{t.forEach(l=>{chrome.tabs.sendMessage(l.id,{type:"soldDataAvailable",data:r.data}).catch(()=>{})})}),e({success:!0});else if(r.type==="apiRequest")return!r.url||!r.url.startsWith(c)?(console.warn("[FlipRadar] API proxy blocked request to non-API URL:",r.url),e({ok:!1,status:0,error:"URL not allowed"}),!0):((async()=>{let t=new AbortController,l=setTimeout(()=>t.abort(),3e4);try{let a={method:r.method||"GET",headers:r.headers||{},signal:t.signal};r.body&&r.method!=="GET"&&(a.body=JSON.stringify(r.body));let u=await fetch(r.url,a),n;try{n=await u.json()}catch(s){console.warn("[FlipRadar] API proxy: failed to parse JSON response:",s.message),n=null}e({ok:u.ok,status:u.status,data:n})}catch(a){console.error("[FlipRadar] API proxy error:",a),e({ok:!1,status:0,error:a.name==="AbortError"?"Request timed out":a.message})}finally{clearTimeout(l)}})(),!0)}return!0});chrome.tabs.onUpdated.addListener((r,o,e)=>{if(o.url&&o.url.includes("/auth/extension/callback")){try{let t=new URL(o.url),l=new URL(c).origin;if(t.origin!==l){console.warn("[FlipRadar] Auth callback blocked from unexpected origin:",t.origin);return}}catch{console.warn("[FlipRadar] Auth callback URL parse failed:",o.url);return}i(o.url,r)}});async function i(r,o){try{let e=new URL(r),t=e.searchParams.get("token"),l=e.searchParams.get("user");if(t){let a=l?JSON.parse(decodeURIComponent(l)):null;await chrome.storage.local.set({authToken:t,user:a}),console.log("[FlipRadar] Auth successful, token stored"),chrome.tabs.remove(o),chrome.runtime.sendMessage({type:"authSuccess",user:a})}}catch(e){console.error("[FlipRadar] Auth callback error:",e)}}chrome.alarms.create("tokenRefresh",{periodInMinutes:30});chrome.alarms.onAlarm.addListener(async r=>{if(r.name==="tokenRefresh"){let o=await chrome.storage.local.get(["authToken"]);if(o.authToken)try{(await fetch(`${c}/api/usage`,{headers:{Authorization:`Bearer ${o.authToken}`}})).status===401&&(await chrome.storage.local.remove(["authToken","user"]),console.log("[FlipRadar] Token expired, cleared"))}catch(e){console.error("[FlipRadar] Token refresh check failed:",e)}}});})();
