(()=>{var u="https://flipradar-iaxg.vercel.app";chrome.runtime.onMessage.addListener((e,a,r)=>(e.type==="openLogin"&&(chrome.tabs.create({url:`${u}/auth/extension`}),r({success:!0})),e.type==="openUpgrade"&&(chrome.tabs.create({url:`${u}/pricing`}),r({success:!0})),e.type==="getAuthToken"?(chrome.storage.local.get(["authToken","user"],t=>{r({token:t.authToken||null,user:t.user||null})}),!0):e.type==="logout"?(chrome.storage.local.remove(["authToken","user"],()=>{r({success:!0})}),!0):(e.type==="getApiBaseUrl"&&r({url:u}),e.type==="soldDataCaptured"&&(chrome.tabs.query({url:"*://www.facebook.com/marketplace/*"},t=>{t.forEach(o=>{chrome.tabs.sendMessage(o.id,{type:"soldDataAvailable",data:e.data}).catch(()=>{})})}),r({success:!0})),e.type==="apiRequest"&&(async()=>{try{let t={method:e.method||"GET",headers:e.headers||{}};e.body&&e.method!=="GET"&&(t.body=JSON.stringify(e.body));let o=await fetch(e.url,t),c;try{c=await o.json()}catch{c=null}r({ok:o.ok,status:o.status,data:c})}catch(t){console.error("[FlipRadar] API proxy error:",t),r({ok:!1,status:0,error:t.message})}})(),!0)));chrome.tabs.onUpdated.addListener((e,a,r)=>{a.url&&a.url.includes("/auth/extension/callback")&&s(a.url,e)});async function s(e,a){try{let r=new URL(e),t=r.searchParams.get("token"),o=r.searchParams.get("user");if(t){let c=o?JSON.parse(decodeURIComponent(o)):null;await chrome.storage.local.set({authToken:t,user:c}),console.log("[FlipRadar] Auth successful, token stored"),chrome.tabs.remove(a),chrome.runtime.sendMessage({type:"authSuccess",user:c})}}catch(r){console.error("[FlipRadar] Auth callback error:",r)}}chrome.alarms.create("tokenRefresh",{periodInMinutes:30});chrome.alarms.onAlarm.addListener(async e=>{if(e.name==="tokenRefresh"){let a=await chrome.storage.local.get(["authToken"]);if(a.authToken)try{(await fetch(`${u}/api/usage`,{headers:{Authorization:`Bearer ${a.authToken}`}})).status===401&&(await chrome.storage.local.remove(["authToken","user"]),console.log("[FlipRadar] Token expired, cleared"))}catch(r){console.error("[FlipRadar] Token refresh check failed:",r)}}});})();
